<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FlightCal</title>
    <meta name="description" content="Flight to Calendar web app" />
    <!-- Bootstrap 5.3 CSS -->
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
    />
    <link rel="stylesheet" href="styles.css" />

</head>
<body>
    <div class="container py-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h4 mb-1">FlightCal</h2>
          <p class="text-muted small mb-4">Create a calendar event for your flight — no login required.</p>
          <form id="flightForm">
  <div class="row g-3">
    <div class="col-12 col-md-6">
      <label class="form-label">Airline</label>
      <select id="airline" class="form-select" required>
        <option value="">Select airline</option>
        <option value="AA">American Airlines (AA)</option>
        <option value="UA">United (UA)</option>
        <option value="DL">Delta (DL)</option>
        <option value="WN">Southwest (WN)</option>
        <option value="BA">British Airways (BA)</option>
      </select>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Flight Number</label>
      <input id="flightIata" class="form-control" placeholder="e.g., AA100 or 100" required />
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-12 col-md-6">
      <label class="form-label">From Airport (IATA)</label>
      <input id="depIata" class="form-control" placeholder="e.g., AUS" required />
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">To Airport (IATA)</label>
      <input id="arrIata" class="form-control" placeholder="e.g., DFW" required />
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-12 col-md-6">
      <label class="form-label">Departure (local date &amp; time)</label>
      <input id="depLocal" type="datetime-local" class="form-control" required />
      <div class="form-text">Local time at departure airport</div>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Arrival (local date &amp; time)</label>
      <input id="arrLocal" type="datetime-local" class="form-control" required />
      <div class="form-text">Local time at arrival airport</div>
    </div>
  </div>

  <div class="mt-3">
    <label class="form-label">Notes (optional)</label>
    <textarea id="notes" rows="3" class="form-control" placeholder="Seat, record locator, baggage, etc."></textarea>
  </div>

  <div class="mt-3">
    <label class="form-label">All-day event?</label>
    <select id="allDay" class="form-select">
      <option value="no" selected>No</option>
      <option value="yes">Yes</option>
    </select>
  </div>

</form>
      <div class="sticky-download" aria-hidden="true">
        <button type="button" id="stickyDownload" class="btn btn-primary w-100">Download .ics</button>
      </div>
        </div>
      </div>
    </div>


 <!-- JAVASCRIPT BELOW -->
<script src="config.js"></script>

<script>
  // Auto-prefix selected airline code to the flight input (e.g., AA → AA100)
  const airlineSel = document.getElementById('airline');
  const flightInput = document.getElementById('flightIata');

  // --- Auto-fill using AviationStack (runs when flight input loses focus) ---
const key = window.AVIATIONSTACK_KEY; // set in config.js
const depIataEl = document.getElementById('depIata');
const arrIataEl = document.getElementById('arrIata');
const depLocalEl = document.getElementById('depLocal');
const arrLocalEl = document.getElementById('arrLocal');

function toDatetimeLocalInput(dt) {
  // dt can be string or Date. Normalize to Date first.
  const d = (dt instanceof Date) ? dt : new Date(dt);
  const pad = (n) => String(n).padStart(2, '0');
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth() + 1);
  const dd = pad(d.getDate());
  const HH = pad(d.getHours());
  const MM = pad(d.getMinutes());
  // type="datetime-local" expects "YYYY-MM-DDTHH:MM"
  return `${yyyy}-${mm}-${dd}T${HH}:${MM}`;
}

async function tryAutofillFromAviationStack() {
  const code = (flightInput.value || '').trim().toUpperCase();
  if (!key || !code || code.length < 3) return; // need something like AA100

  // NOTE: Free AviationStack keys are HTTP-only. Use https if your plan supports it.
  // If you test on Vercel (https), http will be blocked by the browser.
  const url = `/api/flight?code=${encodeURIComponent(code)}`;
  
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) return;
    const json = await res.json();
    const item = json?.data?.[0];
    if (!item) return;

    // Fill airports
    const dep = item.departure || {};
    const arr = item.arrival || {};
    if (dep.iata && !depIataEl.value) depIataEl.value = dep.iata;
    if (arr.iata && !arrIataEl.value) arrIataEl.value = arr.iata;

    // Fill times (scheduled preferred; fall back to estimated)
    const depTime = dep.scheduled || dep.estimated;
    const arrTime = arr.scheduled || arr.estimated;
    if (depTime && !depLocalEl.value) depLocalEl.value = toDatetimeLocalInput(depTime);
    if (arrTime && !arrLocalEl.value) arrLocalEl.value = toDatetimeLocalInput(arrTime);
  } catch {
    // ignore; keep manual flow working
  }
}

// Trigger autofill when user finishes typing flight
flightInput.addEventListener('blur', tryAutofillFromAviationStack);


  if (airlineSel && flightInput) {
    airlineSel.addEventListener('change', () => {
      const code = airlineSel.value.toUpperCase();
      if (!code) return;
      // Remove any existing 2-letter prefix, keep the rest
      const stripped = flightInput.value.replace(/^[A-Za-z]{2}/, '').trim();
      // Prefix selected code if missing/different
      if (!flightInput.value.toUpperCase().startsWith(code)) {
        flightInput.value = code + stripped;
      }
      // Move caret to end so user can continue typing the number
      const len = flightInput.value.length;
      flightInput.setSelectionRange(len, len);
      flightInput.focus();
    });
  }
    // Handle form submit and generate a .ics file for download
  document.getElementById('flightForm').addEventListener('submit', function (e) {
    e.preventDefault(); // prevent page reload on submit

    // Read all input values from the form
    const flightIata = document.getElementById('flightIata').value.trim(); // e.g., AA100
    const airline = document.getElementById('airline').value.trim();       // optional airline name
    const depIata = document.getElementById('depIata').value.trim();       // departure airport IATA
    const arrIata = document.getElementById('arrIata').value.trim();       // arrival airport IATA
    const depLocal = document.getElementById('depLocal').value;            // departure local datetime (YYYY-MM-DDTHH:mm)
    const arrLocal = document.getElementById('arrLocal').value;            // arrival local datetime (YYYY-MM-DDTHH:mm)
    const notes = document.getElementById('notes').value;                  // freeform notes
    const allDay = document.getElementById('allDay').value;                // "yes" or "no"

    // Basic validation for required fields
    if (!flightIata || !depIata || !arrIata || !depLocal || !arrLocal) {
      alert('Please fill all required fields.');
      return;
    }

    // Helper: zero-pad numbers to 2 digits
    const pad = (n) => String(n).padStart(2, '0');

    // Helper: escape special characters for ICS text fields
    function esc(s) {
      return String(s || '')
        .replace(/\\/g, "\\\\")  // backslash
        .replace(/;/g, "\\;")       // semicolon
        .replace(/,/g, "\\,")       // comma
        .replace(/\n/g, "\\n");     // newline
    }

    // Helper: convert local datetime string (YYYY-MM-DDTHH:mm) to UTC format YYYYMMDDTHHMMSSZ
    function toIcsUtc(local) {
      const d = new Date(local);                 // browser interprets as local time
      const yyyy = d.getUTCFullYear();           // UTC year
      const mm = pad(d.getUTCMonth() + 1);       // UTC month (1-12)
      const dd = pad(d.getUTCDate());            // UTC day
      const HH = pad(d.getUTCHours());           // UTC hours
      const MM = pad(d.getUTCMinutes());         // UTC minutes
      const SS = pad(d.getUTCSeconds());         // UTC seconds
      return `${yyyy}${mm}${dd}T${HH}${MM}${SS}Z`; // final ICS UTC string
    }

    // Compute timestamps for ICS
    const now = new Date();
    const dtstamp = `${now.getUTCFullYear()}${pad(now.getUTCMonth() + 1)}${pad(now.getUTCDate())}T${pad(now.getUTCHours())}${pad(now.getUTCMinutes())}${pad(now.getUTCSeconds())}Z`;
    const depUtc = toIcsUtc(depLocal);
    const arrUtc = toIcsUtc(arrLocal);

    // Build the visible title and location lines
    const summary = airlineSel && airlineSel.value ? `${airlineSel.value} ${flightIata}` : `Flight ${flightIata}`; // event title
    const location = `${depIata} → ${arrIata}`;                                     // event location line

    // Create a simple globally unique ID for the event
    const uid = `${flightIata}-${depUtc}@flight-cal.local`;

    // If all-day is selected, produce a date-only event; else include times in UTC
    let vevent = '';
    if (allDay === 'yes') {
      // Derive all-day start and end (end is exclusive, so add one day)
      const d = new Date(depLocal);
      const startDate = `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}`; // VALUE=DATE
      const d2 = new Date(d);
      d2.setDate(d2.getDate() + 1);
      const endDate = `${d2.getFullYear()}${pad(d2.getMonth() + 1)}${pad(d2.getDate())}`;

      vevent = [
        'BEGIN:VEVENT',
        `UID:${uid}`,
        `DTSTAMP:${dtstamp}`,
        `SUMMARY:${esc(summary)}`,
        `LOCATION:${esc(location)}`,
        `DESCRIPTION:${esc(notes)}`,
        'TRANSP:OPAQUE',
        'X-MICROSOFT-CDO-BUSYSTATUS:BUSY',
        'X-MICROSOFT-CDO-IMPORTANCE:1',
        `DTSTART;VALUE=DATE:${startDate}`,
        `DTEND;VALUE=DATE:${endDate}`,
        'END:VEVENT',
      ].join('\r\n');
    } else {
      // Timed event in UTC (Z suffix)
      vevent = [
        'BEGIN:VEVENT',
        `UID:${uid}`,
        `DTSTAMP:${dtstamp}`,
        `SUMMARY:${esc(summary)}`,
        `LOCATION:${esc(location)}`,
        `DESCRIPTION:${esc(notes)}`,
        'TRANSP:OPAQUE',
        'X-MICROSOFT-CDO-BUSYSTATUS:BUSY',
        'X-MICROSOFT-CDO-IMPORTANCE:1',
        `DTSTART:${depUtc}`,
        `DTEND:${arrUtc}`,
        'END:VEVENT',
      ].join('\r\n');
    }

    // Wrap the VEVENT with VCALENDAR (required by calendar apps)
    const ics = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//Flight-Cal//EN',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      vevent,
      'END:VCALENDAR',
      '',
    ].join('\r\n');

    // Trigger a download of the .ics file using a Blob and a temporary link
    const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const datePart = depLocal.slice(0, 10);       // Use YYYY-MM-DD for filename
    const a = document.createElement('a');        // Create a temporary <a>
    a.href = url;                                 // Point it to our Blob URL
    a.download = `${flightIata}-${datePart}.ics`; // Suggest a useful filename
    document.body.appendChild(a);                 // Attach to DOM for Firefox compatibility
    a.click();                                    // Programmatically click to start download
    a.remove();                                   // Remove the temporary link
    URL.revokeObjectURL(url);                     // Release the Blob URL

  });
  // Sticky bar button submits the same form (for mobile ease)
  const stickyBtn = document.getElementById('stickyDownload');
  if (stickyBtn) {
    stickyBtn.addEventListener('click', function () {
      const form = document.getElementById('flightForm');
      if (form && form.requestSubmit) form.requestSubmit();
      else if (form) form.submit();
    });
  }
</script>
  </body>
</html>